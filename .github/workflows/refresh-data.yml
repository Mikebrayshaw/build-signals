name: Refresh Build Signals Data

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      hn_days:
        description: 'Days of HN data to fetch'
        required: false
        default: '7'
      ph_limit:
        description: 'Max Product Hunt posts to fetch'
        required: false
        default: '50'
      skip_trends:
        description: 'Skip Google Trends enrichment'
        required: false
        default: 'false'
        type: boolean
      skip_scoring:
        description: 'Skip AI scoring and tweet generation'
        required: false
        default: 'false'
        type: boolean

env:
  PYTHON_VERSION: '3.11'

jobs:
  fetch-and-load:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create run directory
        id: run_id
        run: |
          RUN_ID=$(date -u +"%Y%m%d_%H%M%S")
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          mkdir -p runs/$RUN_ID

      - name: Fetch Hacker News data
        run: |
          python scripts/hn_listener.py \
            --days ${{ github.event.inputs.hn_days || '7' }} \
            --limit 200 \
            --out-dir runs/${{ steps.run_id.outputs.run_id }}

      - name: Fetch GitHub Trending
        run: |
          python scripts/fetch_github_trending.py \
            --since both \
            --out-dir runs/${{ steps.run_id.outputs.run_id }}

      - name: Fetch Product Hunt data
        env:
          PH_TOKEN: ${{ secrets.PH_TOKEN }}
        run: |
          python scripts/fetch_producthunt.py \
            --days ${{ github.event.inputs.hn_days || '7' }} \
            --limit ${{ github.event.inputs.ph_limit || '100' }} \
            --min-votes 50 \
            --out-dir runs/${{ steps.run_id.outputs.run_id }}

      - name: Fetch Google Trends
        if: ${{ github.event.inputs.skip_trends != 'true' }}
        continue-on-error: true
        run: |
          python scripts/fetch_google_trends.py \
            --input-dir runs/${{ steps.run_id.outputs.run_id }} \
            --out-dir runs/${{ steps.run_id.outputs.run_id }} \
            --max-keywords 20 \
            --sleep 5.0

      - name: Score signals with Claude
        if: ${{ github.event.inputs.skip_scoring != 'true' }}
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python scripts/score_signals.py \
            --input-dir runs/${{ steps.run_id.outputs.run_id }} \
            --out-dir runs/${{ steps.run_id.outputs.run_id }}

      - name: Generate tweet drafts
        if: ${{ github.event.inputs.skip_scoring != 'true' }}
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python scripts/generate_tweets.py \
            --input-dir runs/${{ steps.run_id.outputs.run_id }} \
            --out-dir runs/${{ steps.run_id.outputs.run_id }} \
            --top-n 5

      - name: Load to Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          python scripts/supabase_loader.py \
            --input-dir runs/${{ steps.run_id.outputs.run_id }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-signals-${{ steps.run_id.outputs.run_id }}
          path: runs/${{ steps.run_id.outputs.run_id }}/
          retention-days: 30

      - name: Summary
        run: |
          echo "## Build Signals Run Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ steps.run_id.outputs.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files Generated" >> $GITHUB_STEP_SUMMARY
          ls -la runs/${{ steps.run_id.outputs.run_id }}/ >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Build Signals data refresh failed!"
          echo "## Pipeline Failed" >> $GITHUB_STEP_SUMMARY
          echo "Check the step logs above for details." >> $GITHUB_STEP_SUMMARY
