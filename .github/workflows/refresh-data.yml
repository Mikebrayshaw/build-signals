name: Refresh Build Signals Data

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      hn_days:
        description: 'Days of HN data to fetch'
        required: false
        default: '7'
      ph_limit:
        description: 'Max Product Hunt posts to fetch'
        required: false
        default: '50'

env:
  PYTHON_VERSION: '3.11'

jobs:
  fetch-and-load:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create run directory
        id: run_id
        run: |
          RUN_ID=$(date -u +"%Y%m%d_%H%M%S")
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          mkdir -p runs/$RUN_ID

      - name: Fetch Hacker News data
        run: |
          python scripts/hn_listener.py \
            --days ${{ github.event.inputs.hn_days || '7' }} \
            --limit 200 \
            --out-dir runs/${{ steps.run_id.outputs.run_id }}

      - name: Fetch Product Hunt data
        env:
          PH_TOKEN: ${{ secrets.PH_TOKEN }}
        run: |
          python scripts/fetch_producthunt.py \
            --days ${{ github.event.inputs.hn_days || '7' }} \
            --limit ${{ github.event.inputs.ph_limit || '100' }} \
            --min-votes 50 \
            --out-dir runs/${{ steps.run_id.outputs.run_id }}

      - name: Match GitHub repos
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/match_github.py \
            --input runs/${{ steps.run_id.outputs.run_id }}

      - name: Load to Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          python scripts/supabase_loader.py \
            --input-dir runs/${{ steps.run_id.outputs.run_id }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-signals-${{ steps.run_id.outputs.run_id }}
          path: runs/${{ steps.run_id.outputs.run_id }}/
          retention-days: 30

      - name: Summary
        run: |
          echo "## Build Signals Run Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ steps.run_id.outputs.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files Generated" >> $GITHUB_STEP_SUMMARY
          ls -la runs/${{ steps.run_id.outputs.run_id }}/ >> $GITHUB_STEP_SUMMARY
